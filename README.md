# RapidACi

An R package for the batch treatment of Rapid carbon dioxide response curves (A-Ci) generated by the Li-Cor portable photosynthesis systems.    

The Rapid A-Ci measurement method (RACiR) can save a lot of time characterising photosynthetic capacity of multiple plants. However, this gain in time is rapidly lost during post processing following the response curve measurements to obtain the Vcmax and Jmax values, especially since this repetitive task can produce errors. This script was created to help with the analysis of hundreds of measurement files at once. It will automatically match empty chamber measurement files to A-Ci files. When the leaf area does not entirely cover the chamber opening, like in conifers, it will insert the real leaf area into the measurement files and extract recalculated measurement values before correcting the A and Ci values required to compute Vcmax and Jmax. 

For more information on the Rapid A-Ci method (RACiR), see [Stinziano et al. (2017)](https://onlinelibrary.wiley.com/doi/full/10.1111/pce.12911) and [this video](https://www.licor.com/env/support/LI-6800/videos/fast-a-ci-curves.html) produced by Li-Cor. For the application of this method to conifers, see [Coursolle _et al._ (2019)](https://www.frontiersin.org/articles/10.3389/fpls.2019.01276/abstract).  

Note: the package works with the Excel files generated by the Li-Cor systems only (not the text files) which contain formulas that need to be recalculated when the surface areas are measured after the RACiR curves.    

IMPORTANT: the actual version is not yet adapted for files produced by the LI6400 model.     

## Installation     

```{r}
if(!require("devtools")) install.packages("devtools")    
devtools::install_github("ManuelLamothe/RapidACi")     
```
The package requires the _tidyverse_ and _XLConnect_ packages to work. The plantecophys package is recommended for the calculation of Vcmax and Jmax on the corrected values but is optional (another model could be prefered by the user)

```{r}
if (!require("plantecophys")) install.packages("plantecophys"); library(plantecophys)
```

## Usage       

### First step: Generate a list of files

- All measurement files (including empty and dark chamber measurements, when available) can be placed in a single folder. The file names must include a common part that identifies each **type of file** ("mpty", "fast", "slow", and "dark" are actual default R regex patterns that recognise empty chamber, RACiR A-Ci, standard A-Ci, and dark chamber measurements, respectively) and a **unique sample identifier** that can unambiguously be retrieved by a regex pattern (default recognises a sequence of 3 uppercase letters, followed by an underscore and 3 numbers). The build_list function will then generate a list of the files that are present in the folder and that can be used for the calculations.  
    
- The empty chamber measurements files are paired to A-Ci measurement files automatically if an A-Ci and an empty chamber measurements are given the same 'match adjustment' during the measurements. Otherwise, the script will take the nearest starting time as timestamp to pair A-Ci and empty chamber measurements. (It is also possible to 'manually' modify a match by placing the same value in the 'Match Time' column (timestamp) of an Excel measurement file and its corresponding Empty chamber measurement file).

- By default, 'Match Time' column is the 66th column in LI6800 Excel files ("BN"). This value can vary depending on the user definable settings. Check this value by opening anyone of your LI6800 measurement files.

- If, later on, you need to adjust leaf area values, you need to provide a dataframe containing at least one column for the unique sample identifier (named: “sample_ID”), and one column with the leaf area in mm2 (named: “LeafArea_mm2”). Note: If you use WinSEEDLE, the following hidden function could work to produce the leaf area dataframe (`your_leafArea_df <- RapidACi:::extr_leafArea("some_WinSEEDLE_file.txt"`)


```{r}
LeafArea_df <- read_tsv("data/leafArea.tsv")   #optional

list_files <- build_list(path_to_licor_files = "data/",
                         pattern_empty       = "^(mpty)+.xls",      
                         pattern_rapidACi    = "^(fast)+.xls",      
                         pattern_standardACi = "^(slow)+.xls",      
                         pattern_dark        = "^(dark)+.xls",
                         sampleID_format     = "[:upper:]{3}_[:digit:]{3}",
                         timestamp_column    = "BN",
                         leafArea_df         = LeafArea_df)    
```

### Second step: Use empty chamber measurements to correct A and Ci values

There are two possible scenarios. The simple scenario is when leaves cover the whole opening of the chamber, so no leaf area correction is required. The alternative, is when the measured leaf area is smaller than the chamber opening and/or when leaves are distributed in multiple layers (e.g. conifers) and a correction is thus required. Since leaf area (“Const_S”) is generally evaluated after the measurements, both the A-Ci measurement files and matching empty chamber files have to be modified with the correct leaf area and their values recalculated before proceeding to the A and Ci corrections. Similarly, if you use your own measures of respiration (from the measurements of the samples in a dark chamber), these values will also be recalculated according to the leaf area provided.    

For the correction of A and Ci, we use the coefficients of the best fitting polynomial curve (up to the fifth degree, optional with the *max_degree* argument) on the empty chamber measurements. *delta_max*, *skip_first*, *min_CO2* can also be changed from the default settings. To do this, we recommand turning on the *diagostic_plots* (= TRUE) to see the impact of the changes.    

```{r}
results <- Rapid_aci_correction(list_files, 
                                delta_max = 0.05, 
                                skip_first = 10,
                                min_CO2 = 20, 
                                max_degree = 3, 
                                diagnostic_plots = FALSE)
```

### 3. Calculate Vcmax and Jmax 

The plantecophys package by [Duursma (2015)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0143346) to calculate Vcmax and Jmax for each samples. The option `*useRd* = TRUE` let you use your own measures of respiration (missing values will be estimated).

```{r}
# Since not all samples can be analysed by plantecophys we recommand to launch the function with the *safely* function from the purrr package that produce a list of separated `result` and `error` without stopping the process

X <- map(results, `[[`, "Raci") %>%
     map(safely(~plantecophys::fitaci(., useRd=TRUE, Tcorrect=FALSE)))
     
# to generate the A-Ci plots
map(X, "result") %>% compact() %>% walk(plot)     

# to see errors
map(X, "error") %>% compact() 





```

### EXAMPLES (in construction)

### Assuming that all default parameters are respected:
```{r}
results <- build_list() %>% Rapid_aci_correction()
Raci    <- extr_aci(results) 
```

# Vcmax-Jmax by samples
Y <- map(X, "result") %>% compact()
y <- names(Y)

df <- cbind(sample_ID = as.character(lapply(y, rep, 3) %>% flatten()),
            estimates = rep(c("Vcmax", "Jmax", "Rd"), length(Y)),
            value     = do.call("rbind", map(Y, "pars")) %>% as_tibble())
            
for(i in names(results)) diagnose_sample(results, i, delta_max)
### Vcmax, Jmax table...

identical(map(X, ~ .x$pars[1,1]), map2(X, "pars", c(2,1)))

bind_cols(names(X)), ...    %>% set_names(c("sample_ID", ...)

### See all variables names in an Excel file
getFromExcel(list_files[1]$path[1], variables = NA, show.variables = TRUE)

